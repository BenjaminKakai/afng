(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{5557:function(e,t,o){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return o(6794)}])},6794:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return p}});var n={};o.r(n);var a=o(5893),c=o(9008),s=o.n(c),i=o(7294),l=o(9833),r=o.n(l);function d(e){let{onUserSelect:t}=e;return(0,a.jsxs)("div",{className:r().userSelection,children:[(0,a.jsx)("h3",{children:"\uD83D\uDC68‍\uD83D\uDCBB Select Your Developer Identity"}),(0,a.jsx)("div",{className:r().devSelector,children:[{id:"5717c314-0ed1-4984-aa0d-4af6c961586e",name:"\uD83D\uDD34 Dev 1",subtitle:"Primary Tester",color:"#ff6b6b"},{id:"9a105e6f-ca83-4e09-ab83-46dfdfef112e",name:"\uD83D\uDFE2 Dev 2",subtitle:"Secondary Tester",color:"#4ecdc4"},{id:"4d0ee74a-1dc0-4eeb-bee5-e7a46d1cc608",name:"\uD83D\uDD35 Dev 3",subtitle:"Group Call Host",color:"#45b7d1"},{id:"d019cf14-a715-4d1d-b6b4-16c6d672874b",name:"\uD83D\uDFE1 Dev 4",subtitle:"Mobile Simulator",color:"#96ceb4"}].map(e=>(0,a.jsxs)("button",{onClick:()=>t(e.id),className:r().button,style:{backgroundColor:e.color,padding:"15px",fontSize:"16px",borderRadius:"8px",transition:"transform 0.3s",display:"flex",flexDirection:"column",alignItems:"center",gap:"5px"},onMouseEnter:e=>{e.target.style.transform="translateY(-2px)",e.target.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.target.style.transform="translateY(0)",e.target.style.boxShadow="none"},children:[(0,a.jsx)("span",{style:{fontWeight:"bold"},children:e.name}),(0,a.jsx)("small",{style:{opacity:.8},children:e.subtitle})]},e.id))})]})}function u(e){let{localStream:t,remoteStream:o,audioEnabled:n,videoEnabled:c,acceptCallVisible:s,onAcceptCall:l,onEndCall:d,onToggleAudio:u,onToggleVideo:h}=e,g=(0,i.useRef)(null),m=(0,i.useRef)(null);(0,i.useEffect)(()=>{g.current&&t&&(g.current.srcObject=t)},[t]),(0,i.useEffect)(()=>{m.current&&o&&(m.current.srcObject=o)},[o]);let C=async()=>{try{console.log("Starting screen share"),(await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0})).getVideoTracks()[0].onended=async()=>{console.log("Screen share ended");try{await navigator.mediaDevices.getUserMedia({video:!0}),console.log("Camera restored after screen share")}catch(e){console.error("Error resuming camera:",e)}}}catch(e){console.error("Screen share error:",e)}};return(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:r().videosContainer,children:[(0,a.jsxs)("div",{className:r().videoWrapper,children:[(0,a.jsx)("h4",{children:"You"}),(0,a.jsx)("video",{ref:g,className:r().video,autoPlay:!0,playsInline:!0,muted:!0,style:{display:c?"block":"none"}}),!c&&(0,a.jsx)("div",{className:r().video,style:{display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#333",color:"white"},children:"\uD83D\uDCF7 Video Off"})]}),(0,a.jsxs)("div",{className:r().videoWrapper,children:[(0,a.jsx)("h4",{children:"Remote User"}),(0,a.jsx)("video",{ref:m,className:r().video,autoPlay:!0,playsInline:!0})]})]}),(0,a.jsxs)("div",{style:{margin:"20px 0"},children:[(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:u,children:n?"\uD83C\uDFA4 Mute Audio":"\uD83D\uDD07 Unmute Audio"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:h,children:c?"\uD83D\uDCF9 Turn Off Video":"\uD83D\uDCF7 Turn On Video"}),s&&(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:l,children:"✅ Accept Call"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonRed),onClick:d,children:"\uD83D\uDCDE End Call"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonBlue),onClick:C,children:"\uD83D\uDDA5️ Share Screen"})]})]})}function h(e){let{notification:t,onAccept:o,onDismiss:n}=e;return t.visible?(0,a.jsxs)("div",{className:r().notification,children:[(0,a.jsx)("h3",{children:t.title}),(0,a.jsx)("p",{children:t.message}),t.showAccept&&(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:o,children:"Accept"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonRed),onClick:n,children:"Dismiss"})]}):null}o(7642),window.USERS&&window.USERS;class g{getCurrentUsers(){return window.USERS||{}}setupSocketHandlers(){this.socketManager.on("call-offer",this.handleCallOffer.bind(this)),this.socketManager.on("call-answer",this.handleCallAnswer.bind(this)),this.socketManager.on("ice-candidate",this.handleIceCandidate.bind(this)),this.socketManager.on("call-ended",this.handleCallEnded.bind(this)),this.socketManager.on("room-invite-notification",this.handleRoomInvite.bind(this)),this.socketManager.on("broadcast-room-invite",this.handleBroadcastRoomInvite.bind(this)),this.socketManager.on("webrtc-offer",this.handleWebRTCOffer.bind(this)),this.socketManager.on("webrtc-answer",this.handleWebRTCAnswer.bind(this)),this.socketManager.on("webrtc-ice-candidate",this.handleWebRTCIceCandidate.bind(this)),this.socketManager.on("webrtc-ready",this.handleWebRTCReady.bind(this)),this.socketManager.on("room-join-accepted",this.handleRoomJoinAccepted.bind(this)),this.socketManager.on("room-participant-left",this.handleRoomParticipantLeft.bind(this))}async initMedia(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];try{return console.log("Initializing media (video: ".concat(e,")")),this.localStream&&this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=await navigator.mediaDevices.getUserMedia({video:e,audio:!0}),this.socketManager.emit("debug","Media initialized with ".concat(this.localStream.getTracks().length," tracks")),!0}catch(e){return console.error("Media error: ".concat(e.message)),this.socketManager.emit("error","Media error: ".concat(e.message)),!1}}async initWebRTC(){this.peerConnection&&(console.log("Closing existing peer connection"),this.peerConnection.close());try{console.log("Initializing WebRTC"),this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}],iceCandidatePoolSize:10}),this.localStream&&(console.log("Adding local stream tracks to peer connection"),this.localStream.getTracks().forEach(e=>{console.log("Adding ".concat(e.kind," track: ").concat(e.id)),this.peerConnection.addTrack(e,this.localStream)})),this.peerConnection.onicecandidate=e=>{if(e.candidate){var t,o;let n=this.getCurrentUsers();console.log("Sending ICE candidate: ".concat(e.candidate.candidate)),this.socketManager.socketEmit("ice-candidate",{callId:this.currentCallId,targetId:null===(t=n[this.otherUser])||void 0===t?void 0:t.id,candidate:e.candidate,senderId:null===(o=n[this.socketManager.currentUser])||void 0===o?void 0:o.id})}else console.log("ICE gathering completed")},this.peerConnection.ontrack=e=>{console.log("Received ".concat(e.track.kind," track: ").concat(e.track.id)),e.streams&&e.streams[0]&&(console.log("Setting remote video stream"),this.socketManager.emit("remote-stream",e.streams[0]),this.socketManager.emit("success","Remote ".concat(e.track.kind," connected")))},this.peerConnection.onconnectionstatechange=()=>{console.log("Connection state: ".concat(this.peerConnection.connectionState)),"connected"===this.peerConnection.connectionState?this.socketManager.emit("success","Peer connection established"):"failed"===this.peerConnection.connectionState&&(this.socketManager.emit("error","Connection failed"),this.cleanupCall())},this.peerConnection.oniceconnectionstatechange=()=>{console.log("ICE connection state: ".concat(this.peerConnection.iceConnectionState))},console.log("WebRTC initialized successfully")}catch(e){throw console.error("WebRTC error: ".concat(e.message)),e}}async handleCallOffer(e){let{callId:t,callerId:o,offer:n,callType:a="video"}=Array.isArray(e)?e[0]:e;console.log("Call offer received: ".concat(t," from ").concat(o));let c=this.getCurrentUsers();this.currentCallId=t,this.otherUser=Object.keys(c).find(e=>c[e].id===o),this.socketManager.emit("incoming-call",{callId:t,caller:this.otherUser,callType:a}),setTimeout(()=>{this.currentCallId===t&&(console.log("Call ".concat(t," timed out")),this.socketManager.emit("call-timeout",t),this.cleanupCall())},this.callAcceptTimeout);try{if(!await this.initMedia("video"===a))throw Error("Failed to initialize media");if(await this.initWebRTC(),console.log("Setting remote offer description"),await this.peerConnection.setRemoteDescription(new RTCSessionDescription(n)),this.peerConnection.pendingCandidates){for(let e of(console.log("Processing ".concat(this.peerConnection.pendingCandidates.length," queued ICE candidates")),this.peerConnection.pendingCandidates))try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(e)),console.log("Queued ICE candidate added successfully")}catch(e){console.log("Error adding queued ICE candidate: ".concat(e.message))}this.peerConnection.pendingCandidates=[]}console.log("Creating answer");let e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e),console.log("Ready to accept call - offer processed successfully")}catch(e){console.error("Error handling offer: ".concat(e.message)),this.socketManager.emit("error","Error processing call: ".concat(e.message)),this.cleanupCall()}}async startCall(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"video";console.log("\uD83D\uDD0D WebRTC startCall debug:"),console.log("- targetUser:",e),console.log("- this.socketManager.currentUser:",this.socketManager.currentUser);let o=this.getCurrentUsers();console.log("- USERS object:",o),console.log("- USERS[this.socketManager.currentUser]:",o[this.socketManager.currentUser]);try{var a,c;if(!e){this.socketManager.emit("error","Please select a user to call");return}if(!o[e]||!o[e].id){console.error("❌ USERS[targetUser] or .id is undefined:",e,o[e]),this.socketManager.emit("error","Target user not found or missing id: ".concat(e));return}console.log("\uD83D\uDD0D Step 1: Creating fetch body...");let s={targetUserId:o[e].id,callType:t,settings:{video:"video"===t,audio:!0}};if(console.log("\uD83D\uDD0D Fetch body created:",s),!o[this.socketManager.currentUser]||!o[this.socketManager.currentUser].token){console.error("❌ USERS[this.socketManager.currentUser] or .token is undefined:",this.socketManager.currentUser,o[this.socketManager.currentUser]),this.socketManager.emit("error","Current user not found or missing token: ".concat(this.socketManager.currentUser));return}console.log("\uD83D\uDD0D Step 2: Creating authorization header...");let i=o[this.socketManager.currentUser].token;console.log("\uD83D\uDD0D Auth token (first 50 chars):",(null==i?void 0:i.substring(0,50))+"..."),console.log("\uD83D\uDD0D Step 3: Making fetch call...");let l=await fetch("".concat(n.API_BASE_URL,"/calls"),{method:"POST",headers:{Authorization:"Bearer ".concat(i),"Content-Type":"application/json"},body:JSON.stringify(s)});console.log("\uD83D\uDD0D Step 4: Fetch completed, status:",l.status);let r=await l.json();if(console.log("\uD83D\uDD0D Step 5: Response parsed:",r),!l.ok)throw Error("HTTP ".concat(l.status,": ").concat(JSON.stringify(r)));if(!r.success)throw Error(r.message||"Failed to start call");if(this.currentCallId=r.data.callId,this.otherUser=e,this.socketManager.emit("call-started",{callId:this.currentCallId,callType:t,status:"Calling..."}),!await this.initMedia("video"===t))throw Error("Failed to initialize media");await this.initWebRTC();let d=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(d),this.socketManager.socketEmit("call-offer",{callId:this.currentCallId,targetId:null===(a=o[e])||void 0===a?void 0:a.id,offer:d,callerId:null===(c=o[this.socketManager.currentUser])||void 0===c?void 0:c.id,callType:t}),this.socketManager.emit("success","".concat(t," calling ").concat(e,"..."))}catch(e){console.log("\uD83D\uDEA8 ERROR CAUGHT IN startCall:"),console.log("- Error message:",e.message),console.log("- Error stack:",e.stack),this.socketManager.emit("error","Error: ".concat(e.message)),this.cleanupCall()}}async acceptCall(){if(!this.currentCallId||!this.peerConnection){this.socketManager.emit("error","Cannot accept call: WebRTC not ready");return}try{var e,t;let o=this.getCurrentUsers();console.log("Accepting call ".concat(this.currentCallId));let n=this.peerConnection.localDescription;if(!n||"answer"!==n.type){console.log("No local answer found, creating new one");let e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e)}this.socketManager.socketEmit("call-answer",{callId:this.currentCallId,targetId:null===(e=o[this.otherUser])||void 0===e?void 0:e.id,answer:{type:this.peerConnection.localDescription.type,sdp:this.peerConnection.localDescription.sdp},receiverId:null===(t=o[this.socketManager.currentUser])||void 0===t?void 0:t.id}),console.log("Answer sent via socket"),this.socketManager.emit("call-accepted"),this.socketManager.emit("success","Call accepted")}catch(e){console.error("Error accepting call: ".concat(e.message)),this.socketManager.emit("error","Error: ".concat(e.message))}}async endCall(){if(this.isGroupCall){await this.leaveGroupRoom();return}if(!this.currentCallId){this.socketManager.emit("error","No active call");return}try{var e;let t=this.getCurrentUsers();console.log("Ending call ".concat(this.currentCallId)),this.socketManager.socketEmit("call-end",{callId:this.currentCallId,targetId:null===(e=t[this.otherUser])||void 0===e?void 0:e.id}),this.socketManager.emit("success","Call ended"),this.cleanupCall()}catch(e){console.error("Error ending call: ".concat(e.message)),this.socketManager.emit("error","Error: ".concat(e.message)),this.cleanupCall()}}cleanupCall(){if(this.isGroupCall){this.cleanupGroupCall();return}console.log("Starting 1:1 call cleanup"),this.currentCallId=null,this.otherUser=null,this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.socketManager.emit("call-cleanup"),console.log("1:1 call cleanup completed")}async toggleAudio(){this.localStream&&(this.audioEnabled=!this.audioEnabled,this.localStream.getAudioTracks().forEach(e=>e.enabled=this.audioEnabled),console.log("Audio ".concat(this.audioEnabled?"enabled":"disabled")),this.socketManager.emit("audio-toggled",this.audioEnabled))}async toggleVideo(){this.localStream&&(this.videoEnabled=!this.videoEnabled,this.localStream.getVideoTracks().forEach(e=>e.enabled=this.videoEnabled),console.log("Video ".concat(this.videoEnabled?"enabled":"disabled")),this.socketManager.emit("video-toggled",this.videoEnabled))}handleRoomInvite(e){var t;let o=this.getCurrentUsers();console.log("Room invite notification received:",e),e.targetId===(null===(t=o[this.socketManager.currentUser])||void 0===t?void 0:t.id)&&(this.currentRoomId=e.roomId,this.isGroupCall=!0,this.socketManager.emit("room-invite",e))}handleBroadcastRoomInvite(e){var t,o;let n=this.getCurrentUsers();console.log("Broadcast room invite received:",e),e.targetId===(null===(t=n[this.socketManager.currentUser])||void 0===t?void 0:t.id)&&e.hostId!==(null===(o=n[this.socketManager.currentUser])||void 0===o?void 0:o.id)&&(this.currentRoomId=e.roomId,this.isGroupCall=!0,this.socketManager.emit("room-invite",e))}cleanupGroupCall(){console.log("Starting group call cleanup"),this.groupPeerConnections.forEach((e,t)=>{try{e&&(e.close(),console.log("Closed peer connection for ".concat(t)))}catch(e){console.log("Error closing peer connection for ".concat(t,": ").concat(e.message))}}),this.groupPeerConnections.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>{try{e.stop(),console.log("Stopped ".concat(e.kind," track: ").concat(e.id))}catch(t){console.log("Error stopping ".concat(e.kind," track: ").concat(t.message))}}),this.localStream=null),this.currentRoomId=null,this.isGroupCall=!1,this.socketManager.emit("group-call-cleanup"),console.log("Group call cleanup completed")}async handleCallAnswer(e){console.log("handleCallAnswer called",e)}async handleIceCandidate(e){console.log("handleIceCandidate called",e)}async handleCallEnded(e){console.log("handleCallEnded called",e)}async handleWebRTCOffer(e){console.log("handleWebRTCOffer called",e)}async handleWebRTCAnswer(e){console.log("handleWebRTCAnswer called",e)}async handleWebRTCIceCandidate(e){console.log("handleWebRTCIceCandidate called",e)}async handleWebRTCReady(e){console.log("handleWebRTCReady called",e)}async handleRoomJoinAccepted(e){console.log("handleRoomJoinAccepted called",e)}async handleRoomParticipantLeft(e){console.log("handleRoomParticipantLeft called",e)}getLocalStream(){return this.localStream}getCurrentCallId(){return this.currentCallId}getCurrentRoomId(){return this.currentRoomId}isInGroupCall(){return this.isGroupCall}constructor(e){this.socketManager=e,this.localStream=null,this.peerConnection=null,this.groupPeerConnections=new Map,this.audioEnabled=!0,this.videoEnabled=!0,this.isGroupCall=!1,this.currentRoomId=null,this.currentCallId=null,this.otherUser=null,this.pendingWebRTCOffers=new Map,this.callAcceptTimeout=3e4,this.setupSocketHandlers()}}function m(e){var t;let{currentUser:o,contacts:c}=e,[s,l]=(0,i.useState)(o||null),[m,p]=(0,i.useState)(c||[]),[D,b]=(0,i.useState)(!!o),[f,v]=(0,i.useState)(!1),[S,k]=(0,i.useState)("one-on-one"),[w,I]=(0,i.useState)({visible:!1,callId:"",status:""}),[x,j]=(0,i.useState)(""),[y,E]=(0,i.useState)(["\uD83D\uDD0D Socket logs will appear here..."]),[_,R]=(0,i.useState)({visible:!1,title:"",message:"",showAccept:!1}),[M,N]=(0,i.useState)("Unknown"),[T,A]=(0,i.useState)({visible:!1,name:"",id:"",participants:0}),[U,V]=(0,i.useState)(null),[G,F]=(0,i.useState)(null),[O,W]=(0,i.useState)(!0),[P,L]=(0,i.useState)(!0),[B,z]=(0,i.useState)(!1),[H,J]=(0,i.useState)(""),[Y,X]=(0,i.useState)(!1),q=(0,i.useRef)(null),K=(0,i.useRef)(null),Q=(0,i.useRef)(null);(0,i.useEffect)(()=>{let e;if(!s)return;(q.current=new n.default,K.current=new g(q.current),Y)?(e={id:new URLSearchParams(window.location.search).get("user"),name:s,token:localStorage.getItem("wasaaCallToken")},window.USERS=window.USERS||{},window.USERS[s]=e,window.USERS[e.id]=e,m.forEach(e=>{window.USERS[e.id]={id:e.id,name:e.name,token:null},window.USERS[e.name]=window.USERS[e.id]}),console.log("\uD83D\uDD27 Created global USERS object:",window.USERS),console.log("\uD83D\uDD27 Headless mode user object:",e)):console.log("\uD83D\uDD27 Normal mode user object:",e=ef(s)||{id:localStorage.getItem("wasaaCallUserId"),name:s,token:localStorage.getItem("wasaaCallToken")}),q.current.init(e),Z();let t=t=>{console.log("[GroupCall] Received room-invite:",t,"Current user:",e.id),t.targetId===e.id&&(Q.current=t,eo("\uD83D\uDCDE Group Call Started","".concat(t.hostName,' started "').concat(t.roomName,'". Click Accept to join!'),!0))};return q.current.on("room-invite",t),()=>{q.current&&(q.current.off("room-invite",t),q.current.disconnect()),K.current&&K.current.cleanupCall()}},[s,Y]);let Z=()=>{let e=q.current;e.on("debug",$),e.on("error",ee),e.on("success",et),e.on("incoming-call",ea),e.on("call-started",ec),e.on("call-connected",es),e.on("call-accepted",ei),e.on("call-ended",el),e.on("call-timeout",er),e.on("call-cleanup",ed),e.on("remote-stream",F),e.on("audio-toggled",W),e.on("video-toggled",L),e.on("group-call-cleanup",eu),e.on("user-presence-changed",eh)},$=e=>{let t=new Date().toLocaleTimeString();E(o=>[...o,"[".concat(t,"] ").concat(e)])},ee=e=>{j("❌ ".concat(e)),setTimeout(()=>j(""),5e3)},et=e=>{j("✅ ".concat(e)),setTimeout(()=>j(""),5e3)},eo=function(e,t){let o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];R({visible:!0,title:e,message:t,showAccept:o})},en=()=>{R(e=>({...e,visible:!1}))},ea=e=>{let{callId:t,caller:o,callType:n}=e;I({visible:!0,callId:t,status:"Incoming call..."}),z(!0),v(!0),eo("Incoming ".concat(n," Call"),"From ".concat(o),!0)},ec=e=>{let{callId:t,callType:o,status:n}=e;I({visible:!0,callId:t,status:n}),v(!0),V(K.current.getLocalStream())},es=()=>{I(e=>({...e,status:"Call Connected"})),z(!1)},ei=()=>{I(e=>({...e,status:"Call Connected"})),z(!1)},el=()=>{eo("Call Ended","The call has ended",!1),ed()},er=e=>{eo("Call Missed","You missed the call",!1),ed()},ed=()=>{I({visible:!1,callId:"",status:""}),v(!1),z(!1),V(null),F(null)},eu=()=>{A({visible:!1,name:"",id:"",participants:0}),v(!1),V(null),F(null)},eh=e=>{let t=ev(),o=Array.isArray(e)?e.find(e=>e.userId===t.id):e;o&&N(o.status||"offline")},eg=e=>{l(e),b(!0);{let t=ef(e)||{};localStorage.setItem("wasaaCallUser",e),localStorage.setItem("wasaaCallUserId",t.id||""),localStorage.setItem("wasaaCallToken",t.token||"")}},em=async()=>{en();let e=ev();if(Q.current){let o=Q.current;A({visible:!0,name:o.roomName,id:o.roomId,participants:2}),K.current&&(await K.current.initMedia(!0),V(K.current.getLocalStream())),q.current.socketEmit("join-room",{roomId:o.roomId,userId:e.id,userName:e.name}),q.current.socketEmit("webrtc-ready",{roomId:o.roomId,userId:e.id,userName:e.name}),q.current.socketEmit("room-join-accepted",{roomId:o.roomId,roomName:o.roomName,userId:e.id,userName:e.name,hostId:o.hostId});try{let n=await fetch("/api/rooms/".concat(o.roomId,"/participants"),{headers:{Authorization:"Bearer ".concat(e.token)}});if(n.ok){var t;let a=await n.json(),c=(null===(t=a.data)||void 0===t?void 0:t.participants)||a.data||[];for(let t of c)t.id!==e.id&&await K.current.connectToPeer(t.id,o.roomId);A(e=>({...e,participants:c.length}))}}catch(e){$("Failed to fetch participants or connect to peers: "+e.message)}et("Joined ".concat(o.roomName," successfully!")),Q.current=null,v(!0);return}K.current&&await K.current.acceptCall()},eC=async()=>{K.current&&await K.current.endCall()},ep=async()=>{K.current&&await K.current.toggleAudio()},eD=async()=>{K.current&&await K.current.toggleVideo()},eb=async e=>{let t=ev(),o=await fetch("/api/rooms",{method:"POST",headers:{Authorization:"Bearer ".concat(t.token),"Content-Type":"application/json"},body:JSON.stringify({name:e.roomName,description:e.roomDescription,settings:{audioOnly:e.audioOnly}})});if(!o.ok){ee("Failed to create room");return}let n=await o.json(),a=n.data.roomId||n.data.room.id||n.data.id;A({visible:!0,name:e.roomName,id:a,participants:1}),K.current&&(await K.current.initMedia(!e.audioOnly),V(K.current.getLocalStream())),e.inviteDevs&&e.inviteDevs.length>0?(await fetch("/api/rooms/".concat(a,"/invite"),{method:"POST",headers:{Authorization:"Bearer ".concat(t.token),"Content-Type":"application/json"},body:JSON.stringify({userIds:e.inviteDevs})})).ok?(et('Room "'.concat(e.roomName,'" created and invites sent!')),$("Invites sent to: ".concat(e.inviteDevs.join(", ")))):ee("Failed to send invites"):et('Room "'.concat(e.roomName,'" created successfully')),v(!0)};(0,i.useEffect)(()=>{{let e=localStorage.getItem("wasaaCallUser");e&&(0===m.length||m.some(t=>t.name===e))&&eg(e)}},[m]),(0,i.useEffect)(()=>{if(!c&&s){let e=localStorage.getItem("wasaaCallToken");fetch("/api/contacts",{headers:{Authorization:"Bearer ".concat(e)}}).then(e=>e.json()).then(e=>p(e.contacts||[])).catch(()=>p([]))}},[s,c]),(0,i.useEffect)(()=>{if(!o){let e=localStorage.getItem("wasaaCallUser"),t=localStorage.getItem("wasaaCallToken");e&&t&&(l(e),b(!0))}},[o]),(0,i.useEffect)(()=>{let e=new URLSearchParams(window.location.search),t=e.get("user"),o=e.get("token"),n=e.get("contact"),a=e.get("contactName"),c=e.get("callType");if(console.log("\uD83D\uDD0D URL Params Debug:"),console.log("- Full URL:",window.location.href),console.log("- user:",t),console.log("- token:",o),console.log("- contact:",n),console.log("- contactName:",a),console.log("- callType:",c),t&&o&&n&&c){console.log("\uD83E\uDD16 Running in headless mode - no UI, just call service"),X(!0),localStorage.setItem("wasaaCallUser",t),localStorage.setItem("wasaaCallToken",o),l(t),b(!0);let e=m.find(e=>e.id===n||e.name===n);!e&&n&&a&&(e={id:n,name:a},p(t=>t.some(e=>e.id===n)?t:[...t,e])),(e||n)&&(J(n),setTimeout(async()=>{console.log("\uD83C\uDFAF Headless call service starting ".concat(c," call to ").concat(a||n)),K.current&&n&&await K.current.startCall(n,c)},500))}else console.log("❌ Missing params - showing full UI")},[m]),(0,i.useEffect)(()=>{function e(e){e.data&&"SYNC_CONTACTS"===e.data.type&&Array.isArray(e.data.contacts)&&(p(e.data.contacts),$("Contacts synced from main app via postMessage."))}return window.addEventListener("message",e),()=>window.removeEventListener("message",e)},[]);let ef=e=>m.find(t=>t.name===e),ev=()=>Y?{id:new URLSearchParams(window.location.search).get("user"),name:s,token:localStorage.getItem("wasaaCallToken")}:ef(s)||{id:localStorage.getItem("wasaaCallUserId"),name:s,token:localStorage.getItem("wasaaCallToken")};return(0,a.jsxs)("div",{style:{fontFamily:"Arial, sans-serif",margin:"20px",backgroundColor:"#f5f5f5",color:"#333"},children:[(0,a.jsx)(h,{notification:_,onAccept:em,onDismiss:en}),!Y&&(0,a.jsxs)("div",{className:r().container,children:[(0,a.jsx)("h1",{children:"\uD83C\uDFA5 WASAA Video Call System"}),(0,a.jsx)("p",{style:{color:"#666",marginBottom:"20px"},children:"Enhanced test environment with auto-notifications"}),!D&&(0,a.jsx)(d,{onUserSelect:eg}),D&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:r().userInfo,children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\uD83C\uDFF7️ Logged in as:"})," ",s]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\uD83C\uDD94 User ID:"})," ",null===(t=ef(s))||void 0===t?void 0:t.id]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\uD83D\uDCCA Status:"}),(0,a.jsx)("span",{className:"".concat(r().statusIndicator," ").concat("available"===M?r().statusActive:"")}),M]})]}),(0,a.jsxs)("div",{className:r().tabs,children:[(0,a.jsx)("button",{className:"".concat(r().tab," ").concat("one-on-one"===S?r().tabActive:""),onClick:()=>k("one-on-one"),children:"\uD83D\uDCDE 1:1 Calls"}),(0,a.jsx)("button",{className:"".concat(r().tab," ").concat("group-calls"===S?r().tabActive:""),onClick:()=>k("group-calls"),children:"\uD83D\uDC65 Group Calls"})]}),(0,a.jsx)("div",{className:"".concat(r().tabContent," ").concat("one-on-one"===S?r().tabContentActive:""),children:(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{children:"\uD83D\uDCF1 Make a Direct Call"}),(0,a.jsx)("p",{children:"Select a contact to call:"}),H?null:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("select",{className:r().select,value:H,onChange:e=>J(e.target.value),children:[(0,a.jsx)("option",{value:"",children:"Select a contact..."}),m.filter(e=>e.name!==s).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,a.jsxs)("div",{className:r().controlButtons,children:[(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:()=>handleStartCall("video"),disabled:!H,children:"\uD83D\uDCF9 Start Video Call"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonBlue),onClick:()=>handleStartCall("audio"),disabled:!H,children:"\uD83C\uDFA4 Start Audio Call"})]})]})]})}),(0,a.jsxs)("div",{className:"".concat(r().tabContent," ").concat("group-calls"===S?r().tabContentActive:""),children:[(0,a.jsx)(C,{currentUser:s,contacts:m,onCreateRoom:eb}),T.visible&&(0,a.jsxs)("div",{className:r().currentRoomInfo,children:[(0,a.jsx)("h4",{children:"\uD83C\uDFE0 Current Room"}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Room:"})," ",T.name]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Room ID:"})," ",T.id]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Participants:"})," ",T.participants]})]})]}),w.visible&&(0,a.jsxs)("div",{className:r().callInfo,children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\uD83D\uDCDE Call ID:"})," ",w.callId]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\uD83D\uDCCA Status:"})," ",w.status]})]})]}),(0,a.jsx)("p",{className:x.includes("✅")?r().success:r().error,children:x}),(0,a.jsx)("div",{className:r().debugLog,children:y.map((e,t)=>(0,a.jsx)("div",{children:e},t))}),(0,a.jsxs)("div",{className:r().debugButtons,children:[(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonBlue),onClick:()=>{q.current&&q.current.checkStatus()},children:"\uD83D\uDD0D Check Status"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonBlue),onClick:()=>{E(["\uD83D\uDD0D Socket logs cleared..."])},children:"\uD83D\uDDD1️ Clear Log"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:()=>{var e;$("Testing notification system..."),eo("Test Notification","This is a local test notification",!0);let t=ev();if(q.current&&(null===(e=q.current.socket)||void 0===e?void 0:e.connected)){let e={fromUser:t.name,fromUserId:t.id,message:"Socket test notification",timestamp:new Date().toISOString()};q.current.socketEmit("test-broadcast",e),$("Sent test message: ".concat(JSON.stringify(e)))}else ee("Socket not connected")},children:"\uD83E\uDDEA Test Notifications"}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonRed),onClick:()=>{$("Simulating room invite...");let e={targetId:ev().id,roomId:"test-room-12345",roomName:"Simulated Test Room",hostName:"Test Host",hostId:"test-host-id",type:"group-call-invite"};eo("\uD83D\uDCDE Group Call Started","".concat(e.hostName,' started "').concat(e.roomName,'". Click Accept to join!'),!0),Q.current=e,et("Simulated room invite created!")},children:"\uD83D\uDCDE Simulate Invite"})]})]}),f&&(0,a.jsx)(u,{localStream:U,remoteStream:G,audioEnabled:O,videoEnabled:P,acceptCallVisible:B,onAcceptCall:em,onEndCall:eC,onToggleAudio:ep,onToggleVideo:eD})]})}function C(e){let{currentUser:t,contacts:o=[],onCreateRoom:n}=e,[c,s]=(0,i.useState)(""),[l,d]=(0,i.useState)(""),[u,h]=(0,i.useState)(!1),[g,m]=(0,i.useState)([]);return(0,a.jsxs)("div",{className:r().roomControls,children:[(0,a.jsx)("h3",{children:"\uD83C\uDFE2 Create Group Call Room"}),(0,a.jsxs)("div",{className:r().formGroup,children:[(0,a.jsx)("label",{children:"\uD83C\uDFF7️ Room Name:"}),(0,a.jsx)("input",{type:"text",value:c,onChange:e=>s(e.target.value),placeholder:"e.g., Daily Standup",maxLength:"50"})]}),(0,a.jsxs)("div",{className:r().formGroup,children:[(0,a.jsx)("label",{children:"\uD83D\uDCDD Description (optional):"}),(0,a.jsx)("textarea",{value:l,onChange:e=>d(e.target.value),placeholder:"Meeting purpose"})]}),(0,a.jsxs)("div",{className:r().formGroup,children:[(0,a.jsx)("label",{children:"\uD83D\uDC65 Invite Contacts:"}),(0,a.jsx)("select",{multiple:!0,style:{height:"100px"},value:g,onChange:e=>m(Array.from(e.target.selectedOptions,e=>e.value)),children:o.filter(e=>e.name!==t).map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,a.jsxs)("div",{className:r().checkboxGroup,children:[(0,a.jsx)("input",{type:"checkbox",checked:u,onChange:e=>h(e.target.checked)}),(0,a.jsx)("label",{children:"\uD83C\uDFA4 Audio Only"})]}),(0,a.jsx)("button",{className:"".concat(r().button," ").concat(r().buttonGreen),onClick:()=>{c.trim()&&(n({roomName:c.trim(),roomDescription:l.trim(),audioOnly:u,inviteDevs:g}),s(""),d(""),h(!1),m([]))},style:{width:"100%"},disabled:!c.trim(),children:"\uD83D\uDE80 Create & Join Room"})]})}function p(){return(0,a.jsxs)("div",{children:[(0,a.jsxs)(s(),{children:[(0,a.jsx)("title",{children:"WASAA Video Call System"}),(0,a.jsx)("meta",{name:"description",content:"WASAA Video Call testing environment"}),(0,a.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,a.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,a.jsx)("main",{children:(0,a.jsx)(m,{})})]})}},9833:function(e){e.exports={container:"VideoCall_container__AFHoC",video:"VideoCall_video__QPXE5",groupVideo:"VideoCall_groupVideo__ewm2S",error:"VideoCall_error__Q92HT",success:"VideoCall_success__6Hjmi",button:"VideoCall_button__fmpiF",buttonGreen:"VideoCall_buttonGreen__DXMK8",buttonBlue:"VideoCall_buttonBlue__UfTvq",buttonRed:"VideoCall_buttonRed__9T109",videosContainer:"VideoCall_videosContainer__fXbSB",videoWrapper:"VideoCall_videoWrapper__0Hd_p",statusIndicator:"VideoCall_statusIndicator__WT7Iu",statusActive:"VideoCall_statusActive__i0HDF",notification:"VideoCall_notification__mk8VY",slideDown:"VideoCall_slideDown__nM20z",userSelection:"VideoCall_userSelection__kv01c",devSelector:"VideoCall_devSelector__2Rsnn",tabs:"VideoCall_tabs__DnZTf",tab:"VideoCall_tab__JHESb",tabActive:"VideoCall_tabActive__iHVCL",tabContent:"VideoCall_tabContent__E0NV1",tabContentActive:"VideoCall_tabContentActive__Cpqiz",formGroup:"VideoCall_formGroup__vhgC1",checkboxGroup:"VideoCall_checkboxGroup__wJHwF",select:"VideoCall_select__3mw7Z",userInfo:"VideoCall_userInfo__MbXSi",callInfo:"VideoCall_callInfo__kKZ6m",roomControls:"VideoCall_roomControls__eQaKX",currentRoomInfo:"VideoCall_currentRoomInfo__0oT6k",controlButtons:"VideoCall_controlButtons__KSao8",debugLog:"VideoCall_debugLog__JosRN",debugButtons:"VideoCall_debugButtons__dYDUG"}}},function(e){e.O(0,[774,731,888,179],function(){return e(e.s=5557)}),_N_E=e.O()}]);