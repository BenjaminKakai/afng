(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{5557:function(e,t,o){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return o(6794)}])},6794:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return k}});var n=o(5893),a=o(9008),c=o.n(a),i=o(7294),s=o(9833),l=o.n(s);function r(e){let{onUserSelect:t}=e;return(0,n.jsxs)("div",{className:l().userSelection,children:[(0,n.jsx)("h3",{children:"\uD83D\uDC68‍\uD83D\uDCBB Select Your Developer Identity"}),(0,n.jsx)("div",{className:l().devSelector,children:[{id:"Dev 1",name:"\uD83D\uDD34 Dev 1",subtitle:"Primary Tester",color:"#ff6b6b"},{id:"Dev 2",name:"\uD83D\uDFE2 Dev 2",subtitle:"Secondary Tester",color:"#4ecdc4"},{id:"Dev 3",name:"\uD83D\uDD35 Dev 3",subtitle:"Group Call Host",color:"#45b7d1"},{id:"Dev 4",name:"\uD83D\uDFE1 Dev 4",subtitle:"Mobile Simulator",color:"#96ceb4"}].map(e=>(0,n.jsxs)("button",{onClick:()=>t(e.id),className:l().button,style:{backgroundColor:e.color,padding:"15px",fontSize:"16px",borderRadius:"8px",transition:"transform 0.3s",display:"flex",flexDirection:"column",alignItems:"center",gap:"5px"},onMouseEnter:e=>{e.target.style.transform="translateY(-2px)",e.target.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.target.style.transform="translateY(0)",e.target.style.boxShadow="none"},children:[(0,n.jsx)("span",{style:{fontWeight:"bold"},children:e.name}),(0,n.jsx)("small",{style:{opacity:.8},children:e.subtitle})]},e.id))})]})}function d(e){let{localStream:t,remoteStream:o,audioEnabled:a,videoEnabled:c,acceptCallVisible:s,onAcceptCall:r,onEndCall:d,onToggleAudio:u,onToggleVideo:h}=e,m=(0,i.useRef)(null),g=(0,i.useRef)(null);(0,i.useEffect)(()=>{m.current&&t&&(m.current.srcObject=t)},[t]),(0,i.useEffect)(()=>{g.current&&o&&(g.current.srcObject=o)},[o]);let C=async()=>{try{console.log("Starting screen share"),(await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0})).getVideoTracks()[0].onended=async()=>{console.log("Screen share ended");try{await navigator.mediaDevices.getUserMedia({video:!0}),console.log("Camera restored after screen share")}catch(e){console.error("Error resuming camera:",e)}}}catch(e){console.error("Screen share error:",e)}};return(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:l().videosContainer,children:[(0,n.jsxs)("div",{className:l().videoWrapper,children:[(0,n.jsx)("h4",{children:"You"}),(0,n.jsx)("video",{ref:m,className:l().video,autoPlay:!0,playsInline:!0,muted:!0,style:{display:c?"block":"none"}}),!c&&(0,n.jsx)("div",{className:l().video,style:{display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#333",color:"white"},children:"\uD83D\uDCF7 Video Off"})]}),(0,n.jsxs)("div",{className:l().videoWrapper,children:[(0,n.jsx)("h4",{children:"Remote User"}),(0,n.jsx)("video",{ref:g,className:l().video,autoPlay:!0,playsInline:!0})]})]}),(0,n.jsxs)("div",{style:{margin:"20px 0"},children:[(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:u,children:a?"\uD83C\uDFA4 Mute Audio":"\uD83D\uDD07 Unmute Audio"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:h,children:c?"\uD83D\uDCF9 Turn Off Video":"\uD83D\uDCF7 Turn On Video"}),s&&(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:r,children:"✅ Accept Call"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonRed),onClick:d,children:"\uD83D\uDCDE End Call"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonBlue),onClick:C,children:"\uD83D\uDDA5️ Share Screen"})]})]})}function u(e){let{notification:t,onAccept:o,onDismiss:a}=e;return t.visible?(0,n.jsxs)("div",{className:l().notification,children:[(0,n.jsx)("h3",{children:t.title}),(0,n.jsx)("p",{children:t.message}),t.showAccept&&(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:o,children:"Accept"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonRed),onClick:a,children:"Dismiss"})]}):null}var h=o(7642);let m="dev-api-gateway.wasaachat.com",g="wss://".concat(m,":9638"),C={"Dev 1":{id:"5717c314-0ed1-4984-aa0d-4af6c961586e",token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNTcxN2MzMTQtMGVkMS00OTg0LWFhMGQtNGFmNmM5NjE1ODZlIiwidXNlcl90eXBlIjoiY2xpZW50Iiwicm9sZV9pZCI6ImQ1ODczOWU2LTZlMzgtNGI4My04ZTA5LWIwZDQyMmYzNmUxZiIsInNvdXJjZSI6IndlYiIsImRldmljZV9pZCI6IjUwYjY1MGQzLTRiMWItNGZjMC1iN2ZiLWY3NmJjNzJhMjJlNCIsInNlc3Npb25JZCI6ImQzMTY1YzZhLTJhYWYtNGNjOS1hOTM3LTc4NTFlMGRmZDYxOSIsImlhdCI6MTc1MTc5MjUwNSwiZXhwIjoxNzUxODM1NzA1fQ.7reMsUBiiKWvMdC1Z4SxX_VUnrj8Oi78trqbzYL26F8"},"Dev 2":{id:"9a105e6f-ca83-4e09-ab83-46dfdfef112e",token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiOWExMDVlNmYtY2E4My00ZTA5LWFiODMtNDZkZmRmZWYxMTJlIiwidXNlcl90eXBlIjoiY2xpZW50Iiwicm9zZV9pZCI6ImQ1ODczOWU2LTZlMzgtNGI4My04ZTA5LWIwZDQyMmYzNmUxZiIsInNvdXJjZSI6IndlYiIsImRldmljZV9pZCI6Ijk3ODE2NWI1LWE5NTQtNGJhNS05MDFiLTUyYjE1NmRlYjQ0OSIsInNlc3Npb25JZCI6IjZjNTFhMWRiLWY1NWYtNGY2MS05MDMzLTIxMzVmZjc4MjBiNyIsImlhdCI6MTc1MTc5MjU5NCwiZXhwIjoxNzUxODM1Nzk0fQ.3IenWrcZzm9b-iONl6zEBWF79OUFw9cLlVpGQh-VF5Q"},"Dev 3":{id:"4d0ee74a-1dc0-4eeb-bee5-e7a46d1cc608",token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNTdhZTZlMjYtNGYyMC00OTNmLTllMDAtOTNiMWJmOTdjZmNiIiwidXNlcl90eXBlIjoiY2xpZW50Iiwicm9zZV9pZCI6ImQ1ODczOWU2LTZlMzgtNGI4My04ZTA5LWIwZDQyMmYzNmUxZiIsInNvdXJjZSI6IndlYiIsImRldmljZV9pZCI6ImI4ZTQ4ZTYzLTVmOTgtNDcwYS05ZDM0LTU5NjQ2MGFmODgwZSIsInNlc3Npb25JZCI6ImU2YWQ5N2Y5LTZiYzUtNGQ4Yy1hZjdhLTcxMjJmOGNjNWIxNSIsImlhdCI6MTc1MTczNTU4MCwiZXhwIjoxNzUxNzc4NzgwfQ.pseoEBmT-CicvKnXxSbPgGA8zImS-l5HGk5YpqP4gSw"},"Dev 4":{id:"d019cf14-a715-4d1d-b6b4-16c6d672874b",token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNTdhZTZlMjYtNGYyMC00OTNmLTllMDAtOTNiMWJmOTdjZmNiIiwidXNlcl90eXBlIjoiY2xpZW50Iiwicm9zZV9pZCI6ImQ1ODczOWU2LTZlMzgtNGI4My04ZTA5LWIwZDQyMmYzNmUxZiIsInNvdXJjZSI6IndlYiIsImRldmljZV9pZCI6ImI4ZTQ4ZTYzLTVmOTgtNDcwYS05ZDM0LTU5NjQ2MGFmODgwZSIsInNlc3Npb25JZCI6ImU2YWQ5N2Y5LTZiYzUtNGQ4Yy1hZjdhLTcxMjJmOGNjNWIxNSIsImlhdCI6MTc1MTczNTU4MCwiZXhwIjoxNzUxNzc4NzgwfQ.pseoEBmT-CicvKnXxSbPgGA8zImS-l5HGk5YpqP4gSw"}},p="https://".concat(m,":9638/v1");class I{init(e){return this.currentUser=e,this.socket=(0,h.io)(g,{auth:{token:C[e].token},transports:["websocket"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),this.setupEventListeners(),this.socket}setupEventListeners(){var e=this;this.socket.on("connect",()=>{console.log("Socket connected: ".concat(this.socket.id)),this.joinUserRoom(),this.emit("debug","Socket connected: ".concat(this.socket.id))}),this.socket.on("connect_error",e=>{console.log("Socket error: ".concat(e.message)),this.emit("error","Connection error: ".concat(e.message))}),this.socket.on("disconnect",e=>{console.log("Socket disconnected: ".concat(e)),this.emit("debug","Socket disconnected: ".concat(e))}),this.socket.on("room-invite-notification",e=>{console.log("Received group call invite:",e),this.emit("group-invite",e)}),this.socket.onAny(function(t){for(var o=arguments.length,n=Array(o>1?o-1:0),a=1;a<o;a++)n[a-1]=arguments[a];console.log("Socket event received: ".concat(t),n),e.emit("debug","Socket event received: ".concat(t," with data: ").concat(JSON.stringify(n))),e.eventHandlers.has(t)&&e.eventHandlers.get(t).forEach(e=>{try{e(...n)}catch(e){console.error("Error in event handler for ".concat(t,":"),e)}})})}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}off(e,t){if(this.eventHandlers.has(e)){let o=this.eventHandlers.get(e),n=o.indexOf(t);n>-1&&o.splice(n,1)}}emit(e){for(var t=arguments.length,o=Array(t>1?t-1:0),n=1;n<t;n++)o[n-1]=arguments[n];this.eventHandlers.has(e)&&this.eventHandlers.get(e).forEach(t=>{try{t(...o)}catch(t){console.error("Error in local event handler for ".concat(e,":"),t)}})}socketEmit(e,t){this.socket&&this.socket.connected?this.socket.emit(e,t):console.warn("Socket not connected, cannot emit:",e)}joinUserRoom(){if(!this.socket||!this.socket.connected){this.emit("error","Socket not connected");return}if(this.joinRetryCount>=this.maxJoinRetries){this.emit("error","Failed to join room");return}let e="user:".concat(C[this.currentUser].id);console.log("Joining room: ".concat(e)),this.socket.emit("join-room",{roomId:e,userId:C[this.currentUser].id}),this.socket.emit("user-presence",{userId:C[this.currentUser].id,userName:this.currentUser,status:"available"}),this.joinRetryCount++,this.socket.once("room-joined",()=>{this.joinRetryCount=0,console.log("Joined room: ".concat(e)),this.emit("debug","Joined room: ".concat(e))}),this.socket.once("error",()=>{setTimeout(()=>this.joinUserRoom(),1e3)})}checkStatus(){var e,t,o,n,a,c;console.log("Socket connected: ".concat((null===(e=this.socket)||void 0===e?void 0:e.connected)||!1)),console.log("Socket ID: ".concat((null===(t=this.socket)||void 0===t?void 0:t.id)||"Not connected")),console.log("Current user: ".concat(this.currentUser,", ID: ").concat(null===(o=C[this.currentUser])||void 0===o?void 0:o.id)),this.emit("debug","Socket connected: ".concat((null===(n=this.socket)||void 0===n?void 0:n.connected)||!1)),this.emit("debug","Socket ID: ".concat((null===(a=this.socket)||void 0===a?void 0:a.id)||"Not connected")),this.emit("debug","Current user: ".concat(this.currentUser,", ID: ").concat(null===(c=C[this.currentUser])||void 0===c?void 0:c.id)),this.socket&&this.socket.connected?(this.socket.emit("ping"),this.socket.emit("test-socket-communication",{userId:C[this.currentUser].id,userName:this.currentUser,timestamp:new Date().toISOString()})):this.emit("error","Socket not connected")}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.eventHandlers.clear()}constructor(){this.socket=null,this.currentUser=null,this.eventHandlers=new Map,this.joinRetryCount=0,this.maxJoinRetries=5}}class v{setupSocketHandlers(){this.socketManager.on("call-offer",this.handleCallOffer.bind(this)),this.socketManager.on("call-answer",this.handleCallAnswer.bind(this)),this.socketManager.on("ice-candidate",this.handleIceCandidate.bind(this)),this.socketManager.on("call-ended",this.handleCallEnded.bind(this)),this.socketManager.on("room-invite-notification",this.handleRoomInvite.bind(this)),this.socketManager.on("broadcast-room-invite",this.handleBroadcastRoomInvite.bind(this)),this.socketManager.on("webrtc-offer",this.handleWebRTCOffer.bind(this)),this.socketManager.on("webrtc-answer",this.handleWebRTCAnswer.bind(this)),this.socketManager.on("webrtc-ice-candidate",this.handleWebRTCIceCandidate.bind(this)),this.socketManager.on("webrtc-ready",this.handleWebRTCReady.bind(this)),this.socketManager.on("room-join-accepted",this.handleRoomJoinAccepted.bind(this)),this.socketManager.on("room-participant-left",this.handleRoomParticipantLeft.bind(this))}async initMedia(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];try{return console.log("Initializing media (video: ".concat(e,")")),this.localStream&&this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=await navigator.mediaDevices.getUserMedia({video:e,audio:!0}),this.socketManager.emit("debug","Media initialized with ".concat(this.localStream.getTracks().length," tracks")),!0}catch(e){return console.error("Media error: ".concat(e.message)),this.socketManager.emit("error","Media error: ".concat(e.message)),!1}}async initWebRTC(){this.peerConnection&&(console.log("Closing existing peer connection"),this.peerConnection.close());try{console.log("Initializing WebRTC"),this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}],iceCandidatePoolSize:10}),this.localStream&&(console.log("Adding local stream tracks to peer connection"),this.localStream.getTracks().forEach(e=>{console.log("Adding ".concat(e.kind," track: ").concat(e.id)),this.peerConnection.addTrack(e,this.localStream)})),this.peerConnection.onicecandidate=e=>{if(e.candidate){var t;console.log("Sending ICE candidate: ".concat(e.candidate.candidate)),this.socketManager.socketEmit("ice-candidate",{callId:this.currentCallId,targetId:null===(t=C[this.otherUser])||void 0===t?void 0:t.id,candidate:e.candidate,senderId:C[this.socketManager.currentUser].id})}else console.log("ICE gathering completed")},this.peerConnection.ontrack=e=>{console.log("Received ".concat(e.track.kind," track: ").concat(e.track.id)),e.streams&&e.streams[0]&&(console.log("Setting remote video stream"),this.socketManager.emit("remote-stream",e.streams[0]),this.socketManager.emit("success","Remote ".concat(e.track.kind," connected")))},this.peerConnection.onconnectionstatechange=()=>{console.log("Connection state: ".concat(this.peerConnection.connectionState)),"connected"===this.peerConnection.connectionState?this.socketManager.emit("success","Peer connection established"):"failed"===this.peerConnection.connectionState&&(this.socketManager.emit("error","Connection failed"),this.cleanupCall())},this.peerConnection.oniceconnectionstatechange=()=>{console.log("ICE connection state: ".concat(this.peerConnection.iceConnectionState))},console.log("WebRTC initialized successfully")}catch(e){throw console.error("WebRTC error: ".concat(e.message)),e}}async handleCallOffer(e){let{callId:t,callerId:o,offer:n,callType:a="video"}=Array.isArray(e)?e[0]:e;console.log("Call offer received: ".concat(t," from ").concat(o)),this.currentCallId=t,this.otherUser=Object.keys(C).find(e=>C[e].id===o),this.socketManager.emit("incoming-call",{callId:t,caller:this.otherUser,callType:a}),setTimeout(()=>{this.currentCallId===t&&(console.log("Call ".concat(t," timed out")),this.socketManager.emit("call-timeout",t),this.cleanupCall())},this.callAcceptTimeout);try{if(!await this.initMedia("video"===a))throw Error("Failed to initialize media");if(await this.initWebRTC(),console.log("Setting remote offer description"),await this.peerConnection.setRemoteDescription(new RTCSessionDescription(n)),this.peerConnection.pendingCandidates){for(let e of(console.log("Processing ".concat(this.peerConnection.pendingCandidates.length," queued ICE candidates")),this.peerConnection.pendingCandidates))try{await this.peerConnection.addIceCandidate(new RTCIceCandidate(e)),console.log("Queued ICE candidate added successfully")}catch(e){console.log("Error adding queued ICE candidate: ".concat(e.message))}this.peerConnection.pendingCandidates=[]}console.log("Creating answer");let e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e),console.log("Ready to accept call - offer processed successfully")}catch(e){console.error("Error handling offer: ".concat(e.message)),this.socketManager.emit("error","Error processing call: ".concat(e.message)),this.cleanupCall()}}async startCall(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"video";if(!e){this.socketManager.emit("error","Please select a user to call");return}if(this.currentCallId){this.socketManager.emit("error","A call is already in progress");return}try{console.log("Starting ".concat(t," call to ").concat(e));let o=await fetch("".concat(p,"/calls"),{method:"POST",headers:{Authorization:"Bearer ".concat(C[this.socketManager.currentUser].token),"Content-Type":"application/json"},body:JSON.stringify({targetUserId:C[e].id,callType:t,settings:{video:"video"===t,audio:!0}})});if(!o.ok)throw Error("HTTP ".concat(o.status,": ").concat(await o.text()));let n=await o.json();if(!n.success)throw Error(n.message||"Failed to start call");if(this.currentCallId=n.data.callId,this.otherUser=e,this.socketManager.emit("call-started",{callId:this.currentCallId,callType:t,status:"Calling..."}),!await this.initMedia("video"===t))throw Error("Failed to initialize media");await this.initWebRTC();let a=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(a),this.socketManager.socketEmit("call-offer",{callId:this.currentCallId,targetId:C[e].id,offer:a,callerId:C[this.socketManager.currentUser].id,callType:t}),this.socketManager.emit("success","".concat(t," calling ").concat(e,"..."))}catch(e){console.error("Error starting call: ".concat(e.message)),this.socketManager.emit("error","Error: ".concat(e.message)),this.cleanupCall()}}async acceptCall(){if(!this.currentCallId||!this.peerConnection){this.socketManager.emit("error","Cannot accept call: WebRTC not ready");return}try{console.log("Accepting call ".concat(this.currentCallId));let e=this.peerConnection.localDescription;if(!e||"answer"!==e.type){console.log("No local answer found, creating new one");let e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e)}this.socketManager.socketEmit("call-answer",{callId:this.currentCallId,targetId:C[this.otherUser].id,answer:{type:this.peerConnection.localDescription.type,sdp:this.peerConnection.localDescription.sdp},receiverId:C[this.socketManager.currentUser].id}),console.log("Answer sent via socket"),this.socketManager.emit("call-accepted"),this.socketManager.emit("success","Call accepted")}catch(e){console.error("Error accepting call: ".concat(e.message)),this.socketManager.emit("error","Error: ".concat(e.message))}}async endCall(){if(this.isGroupCall){await this.leaveGroupRoom();return}if(!this.currentCallId){this.socketManager.emit("error","No active call");return}try{var e;console.log("Ending call ".concat(this.currentCallId)),this.socketManager.socketEmit("call-end",{callId:this.currentCallId,targetId:null===(e=C[this.otherUser])||void 0===e?void 0:e.id}),this.socketManager.emit("success","Call ended"),this.cleanupCall()}catch(e){console.error("Error ending call: ".concat(e.message)),this.socketManager.emit("error","Error: ".concat(e.message)),this.cleanupCall()}}cleanupCall(){if(this.isGroupCall){this.cleanupGroupCall();return}console.log("Starting 1:1 call cleanup"),this.currentCallId=null,this.otherUser=null,this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.socketManager.emit("call-cleanup"),console.log("1:1 call cleanup completed")}async toggleAudio(){this.localStream&&(this.audioEnabled=!this.audioEnabled,this.localStream.getAudioTracks().forEach(e=>e.enabled=this.audioEnabled),console.log("Audio ".concat(this.audioEnabled?"enabled":"disabled")),this.socketManager.emit("audio-toggled",this.audioEnabled))}async toggleVideo(){this.localStream&&(this.videoEnabled=!this.videoEnabled,this.localStream.getVideoTracks().forEach(e=>e.enabled=this.videoEnabled),console.log("Video ".concat(this.videoEnabled?"enabled":"disabled")),this.socketManager.emit("video-toggled",this.videoEnabled))}handleRoomInvite(e){console.log("Room invite notification received:",e),e.targetId===C[this.socketManager.currentUser].id&&(this.currentRoomId=e.roomId,this.isGroupCall=!0,this.socketManager.emit("room-invite",e))}handleBroadcastRoomInvite(e){console.log("Broadcast room invite received:",e),e.targetId===C[this.socketManager.currentUser].id&&e.hostId!==C[this.socketManager.currentUser].id&&(this.currentRoomId=e.roomId,this.isGroupCall=!0,this.socketManager.emit("room-invite",e))}cleanupGroupCall(){console.log("Starting group call cleanup"),this.groupPeerConnections.forEach((e,t)=>{try{e&&(e.close(),console.log("Closed peer connection for ".concat(t)))}catch(e){console.log("Error closing peer connection for ".concat(t,": ").concat(e.message))}}),this.groupPeerConnections.clear(),this.localStream&&(this.localStream.getTracks().forEach(e=>{try{e.stop(),console.log("Stopped ".concat(e.kind," track: ").concat(e.id))}catch(t){console.log("Error stopping ".concat(e.kind," track: ").concat(t.message))}}),this.localStream=null),this.currentRoomId=null,this.isGroupCall=!1,this.socketManager.emit("group-call-cleanup"),console.log("Group call cleanup completed")}async handleCallAnswer(e){console.log("handleCallAnswer called",e)}async handleIceCandidate(e){console.log("handleIceCandidate called",e)}async handleCallEnded(e){console.log("handleCallEnded called",e)}async handleWebRTCOffer(e){console.log("handleWebRTCOffer called",e)}async handleWebRTCAnswer(e){console.log("handleWebRTCAnswer called",e)}async handleWebRTCIceCandidate(e){console.log("handleWebRTCIceCandidate called",e)}async handleWebRTCReady(e){console.log("handleWebRTCReady called",e)}async handleRoomJoinAccepted(e){console.log("handleRoomJoinAccepted called",e)}async handleRoomParticipantLeft(e){console.log("handleRoomParticipantLeft called",e)}getLocalStream(){return this.localStream}getCurrentCallId(){return this.currentCallId}getCurrentRoomId(){return this.currentRoomId}isInGroupCall(){return this.isGroupCall}constructor(e){this.socketManager=e,this.localStream=null,this.peerConnection=null,this.groupPeerConnections=new Map,this.audioEnabled=!0,this.videoEnabled=!0,this.isGroupCall=!1,this.currentRoomId=null,this.currentCallId=null,this.otherUser=null,this.pendingWebRTCOffers=new Map,this.callAcceptTimeout=3e4,this.setupSocketHandlers()}}function b(e){var t;let{currentUser:o,contacts:a}=e,[c,s]=(0,i.useState)(o||null),[h,m]=(0,i.useState)(a||[]),[g,C]=(0,i.useState)(!!o),[p,b]=(0,i.useState)(!1),[k,D]=(0,i.useState)("one-on-one"),[S,j]=(0,i.useState)({visible:!1,callId:"",status:""}),[N,x]=(0,i.useState)(""),[y,w]=(0,i.useState)(["\uD83D\uDD0D Socket logs will appear here..."]),[M,T]=(0,i.useState)({visible:!1,title:"",message:"",showAccept:!1}),[E,R]=(0,i.useState)("Unknown"),[_,U]=(0,i.useState)({visible:!1,name:"",id:"",participants:0}),[A,Z]=(0,i.useState)(null),[V,O]=(0,i.useState)(null),[G,z]=(0,i.useState)(!0),[W,Y]=(0,i.useState)(!0),[L,J]=(0,i.useState)(!1),[F,X]=(0,i.useState)(""),[B,Q]=(0,i.useState)(!1),P=(0,i.useRef)(null),H=(0,i.useRef)(null),q=(0,i.useRef)(null);(0,i.useEffect)(()=>{if(!c)return;P.current=new I,P.current.init(c),H.current=new v(P.current),K();let e=e=>{var t;console.log("[GroupCall] Received room-invite:",e,"Current user:",null===(t=USERS[c])||void 0===t?void 0:t.id),e.targetId===USERS[c].id&&(q.current=e,eo("\uD83D\uDCDE Group Call Started","".concat(e.hostName,' started "').concat(e.roomName,'". Click Accept to join!'),!0))};return P.current.on("room-invite",e),()=>{P.current&&(P.current.off("room-invite",e),P.current.disconnect()),H.current&&H.current.cleanupCall()}},[c]);let K=()=>{let e=P.current;e.on("debug",$),e.on("error",ee),e.on("success",et),e.on("incoming-call",ea),e.on("call-started",ec),e.on("call-connected",ei),e.on("call-accepted",es),e.on("call-ended",el),e.on("call-timeout",er),e.on("call-cleanup",ed),e.on("remote-stream",O),e.on("audio-toggled",z),e.on("video-toggled",Y),e.on("group-call-cleanup",eu),e.on("user-presence-changed",eh)},$=e=>{let t=new Date().toLocaleTimeString();w(o=>[...o,"[".concat(t,"] ").concat(e)])},ee=e=>{x("❌ ".concat(e)),setTimeout(()=>x(""),5e3)},et=e=>{x("✅ ".concat(e)),setTimeout(()=>x(""),5e3)},eo=function(e,t){let o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];T({visible:!0,title:e,message:t,showAccept:o})},en=()=>{T(e=>({...e,visible:!1}))},ea=e=>{let{callId:t,caller:o,callType:n}=e;j({visible:!0,callId:t,status:"Incoming call..."}),J(!0),b(!0),eo("Incoming ".concat(n," Call"),"From ".concat(o),!0)},ec=e=>{let{callId:t,callType:o,status:n}=e;j({visible:!0,callId:t,status:n}),b(!0),Z(H.current.getLocalStream())},ei=()=>{j(e=>({...e,status:"Call Connected"})),J(!1)},es=()=>{j(e=>({...e,status:"Call Connected"})),J(!1)},el=()=>{eo("Call Ended","The call has ended",!1),ed()},er=e=>{eo("Call Missed","You missed the call",!1),ed()},ed=()=>{j({visible:!1,callId:"",status:""}),b(!1),J(!1),Z(null),O(null)},eu=()=>{U({visible:!1,name:"",id:"",participants:0}),b(!1),Z(null),O(null)},eh=e=>{let t=Array.isArray(e)?e.find(e=>e.userId===USERS[c].id):e;t&&R(t.status||"offline")},em=e=>{s(e),C(!0);{let t=ef(e)||{};localStorage.setItem("wasaaCallUser",e),localStorage.setItem("wasaaCallUserId",t.id||""),localStorage.setItem("wasaaCallToken",t.token||"")}},eg=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"video";H.current&&F&&await H.current.startCall(F,e)},eC=async()=>{if(en(),q.current){let t=q.current;U({visible:!0,name:t.roomName,id:t.roomId,participants:2}),H.current&&(await H.current.initMedia(!0),Z(H.current.getLocalStream())),P.current.socketEmit("join-room",{roomId:t.roomId,userId:USERS[c].id,userName:c}),P.current.socketEmit("webrtc-ready",{roomId:t.roomId,userId:USERS[c].id,userName:c}),P.current.socketEmit("room-join-accepted",{roomId:t.roomId,roomName:t.roomName,userId:USERS[c].id,userName:c,hostId:t.hostId});try{let o=await fetch("/api/rooms/".concat(t.roomId,"/participants"),{headers:{Authorization:"Bearer ".concat(USERS[c].token)}});if(o.ok){var e;let n=await o.json(),a=(null===(e=n.data)||void 0===e?void 0:e.participants)||n.data||[];for(let e of a)e.id!==USERS[c].id&&await H.current.connectToPeer(e.id,t.roomId);U(e=>({...e,participants:a.length}))}}catch(e){$("Failed to fetch participants or connect to peers: "+e.message)}et("Joined ".concat(t.roomName," successfully!")),q.current=null,b(!0);return}H.current&&await H.current.acceptCall()},ep=async()=>{H.current&&await H.current.endCall()},eI=async()=>{H.current&&await H.current.toggleAudio()},ev=async()=>{H.current&&await H.current.toggleVideo()},eb=async e=>{let t=await fetch("/api/rooms",{method:"POST",headers:{Authorization:"Bearer ".concat(USERS[c].token),"Content-Type":"application/json"},body:JSON.stringify({name:e.roomName,description:e.roomDescription,settings:{audioOnly:e.audioOnly}})});if(!t.ok){ee("Failed to create room");return}let o=await t.json(),n=o.data.roomId||o.data.room.id||o.data.id;U({visible:!0,name:e.roomName,id:n,participants:1}),H.current&&(await H.current.initMedia(!e.audioOnly),Z(H.current.getLocalStream())),e.inviteDevs&&e.inviteDevs.length>0?(await fetch("/api/rooms/".concat(n,"/invite"),{method:"POST",headers:{Authorization:"Bearer ".concat(USERS[c].token),"Content-Type":"application/json"},body:JSON.stringify({userIds:e.inviteDevs})})).ok?(et('Room "'.concat(e.roomName,'" created and invites sent!')),$("Invites sent to: ".concat(e.inviteDevs.join(", ")))):ee("Failed to send invites"):et('Room "'.concat(e.roomName,'" created successfully')),b(!0)};(0,i.useEffect)(()=>{{let e=localStorage.getItem("wasaaCallUser");e&&(0===h.length||h.some(t=>t.name===e))&&em(e)}},[h]),(0,i.useEffect)(()=>{if(!a&&c){let e=localStorage.getItem("wasaaCallToken");fetch("/api/contacts",{headers:{Authorization:"Bearer ".concat(e)}}).then(e=>e.json()).then(e=>m(e.contacts||[])).catch(()=>m([]))}},[c,a]),(0,i.useEffect)(()=>{if(!o){let e=localStorage.getItem("wasaaCallUser"),t=localStorage.getItem("wasaaCallToken");e&&t&&(s(e),C(!0))}},[o]),(0,i.useEffect)(()=>{let e=new URLSearchParams(window.location.search),t=e.get("user"),o=e.get("token"),n=e.get("contact"),a=e.get("contactName"),c=e.get("callType");if(t&&o&&n&&c){console.log("\uD83E\uDD16 Running in headless mode - no UI, just call service"),Q(!0),localStorage.setItem("wasaaCallUser",t),localStorage.setItem("wasaaCallToken",o),s(t),C(!0);let e=h.find(e=>e.id===n||e.name===n);!e&&n&&a&&(e={id:n,name:a},m(t=>t.some(e=>e.id===n)?t:[...t,e])),(e||n)&&(X(n),setTimeout(()=>{console.log("\uD83C\uDFAF Headless call service starting ".concat(c," call to ").concat(a||n)),eg(c)},300))}},[h]),(0,i.useEffect)(()=>{function e(e){e.data&&"SYNC_CONTACTS"===e.data.type&&Array.isArray(e.data.contacts)&&(m(e.data.contacts),$("Contacts synced from main app via postMessage."))}return window.addEventListener("message",e),()=>window.removeEventListener("message",e)},[]);let ef=e=>h.find(t=>t.name===e);return(0,n.jsxs)("div",{style:{fontFamily:"Arial, sans-serif",margin:"20px",backgroundColor:"#f5f5f5",color:"#333"},children:[(0,n.jsx)(u,{notification:M,onAccept:eC,onDismiss:en}),!B&&(0,n.jsxs)("div",{className:l().container,children:[(0,n.jsx)("h1",{children:"\uD83C\uDFA5 WASAA Video Call System"}),(0,n.jsx)("p",{style:{color:"#666",marginBottom:"20px"},children:"Enhanced test environment with auto-notifications"}),!g&&(0,n.jsx)(r,{onUserSelect:em}),g&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:l().userInfo,children:[(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\uD83C\uDFF7️ Logged in as:"})," ",c]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\uD83C\uDD94 User ID:"})," ",null===(t=ef(c))||void 0===t?void 0:t.id]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\uD83D\uDCCA Status:"}),(0,n.jsx)("span",{className:"".concat(l().statusIndicator," ").concat("available"===E?l().statusActive:"")}),E]})]}),(0,n.jsxs)("div",{className:l().tabs,children:[(0,n.jsx)("button",{className:"".concat(l().tab," ").concat("one-on-one"===k?l().tabActive:""),onClick:()=>D("one-on-one"),children:"\uD83D\uDCDE 1:1 Calls"}),(0,n.jsx)("button",{className:"".concat(l().tab," ").concat("group-calls"===k?l().tabActive:""),onClick:()=>D("group-calls"),children:"\uD83D\uDC65 Group Calls"})]}),(0,n.jsx)("div",{className:"".concat(l().tabContent," ").concat("one-on-one"===k?l().tabContentActive:""),children:(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{children:"\uD83D\uDCF1 Make a Direct Call"}),(0,n.jsx)("p",{children:"Select a contact to call:"}),F?null:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("select",{className:l().select,value:F,onChange:e=>X(e.target.value),children:[(0,n.jsx)("option",{value:"",children:"Select a contact..."}),h.filter(e=>e.name!==c).map(e=>(0,n.jsx)("option",{value:e.id,children:e.name},e.id))]}),(0,n.jsxs)("div",{className:l().controlButtons,children:[(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:()=>eg("video"),disabled:!F,children:"\uD83D\uDCF9 Start Video Call"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonBlue),onClick:()=>eg("audio"),disabled:!F,children:"\uD83C\uDFA4 Start Audio Call"})]})]})]})}),(0,n.jsxs)("div",{className:"".concat(l().tabContent," ").concat("group-calls"===k?l().tabContentActive:""),children:[(0,n.jsx)(f,{currentUser:c,contacts:h,onCreateRoom:eb}),_.visible&&(0,n.jsxs)("div",{className:l().currentRoomInfo,children:[(0,n.jsx)("h4",{children:"\uD83C\uDFE0 Current Room"}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Room:"})," ",_.name]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Room ID:"})," ",_.id]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Participants:"})," ",_.participants]})]})]}),S.visible&&(0,n.jsxs)("div",{className:l().callInfo,children:[(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\uD83D\uDCDE Call ID:"})," ",S.callId]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"\uD83D\uDCCA Status:"})," ",S.status]})]})]}),(0,n.jsx)("p",{className:N.includes("✅")?l().success:l().error,children:N}),(0,n.jsx)("div",{className:l().debugLog,children:y.map((e,t)=>(0,n.jsx)("div",{children:e},t))}),(0,n.jsxs)("div",{className:l().debugButtons,children:[(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonBlue),onClick:()=>{P.current&&P.current.checkStatus()},children:"\uD83D\uDD0D Check Status"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonBlue),onClick:()=>{w(["\uD83D\uDD0D Socket logs cleared..."])},children:"\uD83D\uDDD1️ Clear Log"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:()=>{var e;if($("Testing notification system..."),eo("Test Notification","This is a local test notification",!0),P.current&&(null===(e=P.current.socket)||void 0===e?void 0:e.connected)){let e={fromUser:c,fromUserId:USERS[c].id,message:"Socket test notification",timestamp:new Date().toISOString()};P.current.socketEmit("test-broadcast",e),$("Sent test message: ".concat(JSON.stringify(e)))}else ee("Socket not connected")},children:"\uD83E\uDDEA Test Notifications"}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonRed),onClick:()=>{$("Simulating room invite...");let e={targetId:USERS[c].id,roomId:"test-room-12345",roomName:"Simulated Test Room",hostName:"Test Host",hostId:"test-host-id",type:"group-call-invite"};eo("\uD83D\uDCDE Group Call Started","".concat(e.hostName,' started "').concat(e.roomName,'". Click Accept to join!'),!0),q.current=e,et("Simulated room invite created!")},children:"\uD83D\uDCDE Simulate Invite"})]})]}),p&&(0,n.jsx)(d,{localStream:A,remoteStream:V,audioEnabled:G,videoEnabled:W,acceptCallVisible:L,onAcceptCall:eC,onEndCall:ep,onToggleAudio:eI,onToggleVideo:ev})]})}function f(e){let{currentUser:t,contacts:o=[],onCreateRoom:a}=e,[c,s]=(0,i.useState)(""),[r,d]=(0,i.useState)(""),[u,h]=(0,i.useState)(!1),[m,g]=(0,i.useState)([]);return(0,n.jsxs)("div",{className:l().roomControls,children:[(0,n.jsx)("h3",{children:"\uD83C\uDFE2 Create Group Call Room"}),(0,n.jsxs)("div",{className:l().formGroup,children:[(0,n.jsx)("label",{children:"\uD83C\uDFF7️ Room Name:"}),(0,n.jsx)("input",{type:"text",value:c,onChange:e=>s(e.target.value),placeholder:"e.g., Daily Standup",maxLength:"50"})]}),(0,n.jsxs)("div",{className:l().formGroup,children:[(0,n.jsx)("label",{children:"\uD83D\uDCDD Description (optional):"}),(0,n.jsx)("textarea",{value:r,onChange:e=>d(e.target.value),placeholder:"Meeting purpose"})]}),(0,n.jsxs)("div",{className:l().formGroup,children:[(0,n.jsx)("label",{children:"\uD83D\uDC65 Invite Contacts:"}),(0,n.jsx)("select",{multiple:!0,style:{height:"100px"},value:m,onChange:e=>g(Array.from(e.target.selectedOptions,e=>e.value)),children:o.filter(e=>e.name!==t).map(e=>(0,n.jsx)("option",{value:e.id,children:e.name},e.id))})]}),(0,n.jsxs)("div",{className:l().checkboxGroup,children:[(0,n.jsx)("input",{type:"checkbox",checked:u,onChange:e=>h(e.target.checked)}),(0,n.jsx)("label",{children:"\uD83C\uDFA4 Audio Only"})]}),(0,n.jsx)("button",{className:"".concat(l().button," ").concat(l().buttonGreen),onClick:()=>{c.trim()&&(a({roomName:c.trim(),roomDescription:r.trim(),audioOnly:u,inviteDevs:m}),s(""),d(""),h(!1),g([]))},style:{width:"100%"},disabled:!c.trim(),children:"\uD83D\uDE80 Create & Join Room"})]})}function k(){return(0,n.jsxs)("div",{children:[(0,n.jsxs)(c(),{children:[(0,n.jsx)("title",{children:"WASAA Video Call System"}),(0,n.jsx)("meta",{name:"description",content:"WASAA Video Call testing environment"}),(0,n.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,n.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,n.jsx)("main",{children:(0,n.jsx)(b,{})})]})}},9833:function(e){e.exports={container:"VideoCall_container__AFHoC",video:"VideoCall_video__QPXE5",groupVideo:"VideoCall_groupVideo__ewm2S",error:"VideoCall_error__Q92HT",success:"VideoCall_success__6Hjmi",button:"VideoCall_button__fmpiF",buttonGreen:"VideoCall_buttonGreen__DXMK8",buttonBlue:"VideoCall_buttonBlue__UfTvq",buttonRed:"VideoCall_buttonRed__9T109",videosContainer:"VideoCall_videosContainer__fXbSB",videoWrapper:"VideoCall_videoWrapper__0Hd_p",statusIndicator:"VideoCall_statusIndicator__WT7Iu",statusActive:"VideoCall_statusActive__i0HDF",notification:"VideoCall_notification__mk8VY",slideDown:"VideoCall_slideDown__nM20z",userSelection:"VideoCall_userSelection__kv01c",devSelector:"VideoCall_devSelector__2Rsnn",tabs:"VideoCall_tabs__DnZTf",tab:"VideoCall_tab__JHESb",tabActive:"VideoCall_tabActive__iHVCL",tabContent:"VideoCall_tabContent__E0NV1",tabContentActive:"VideoCall_tabContentActive__Cpqiz",formGroup:"VideoCall_formGroup__vhgC1",checkboxGroup:"VideoCall_checkboxGroup__wJHwF",select:"VideoCall_select__3mw7Z",userInfo:"VideoCall_userInfo__MbXSi",callInfo:"VideoCall_callInfo__kKZ6m",roomControls:"VideoCall_roomControls__eQaKX",currentRoomInfo:"VideoCall_currentRoomInfo__0oT6k",controlButtons:"VideoCall_controlButtons__KSao8",debugLog:"VideoCall_debugLog__JosRN",debugButtons:"VideoCall_debugButtons__dYDUG"}}},function(e){e.O(0,[774,731,888,179],function(){return e(e.s=5557)}),_N_E=e.O()}]);